---
const scriptTagForGiscus = `
<script src="https://giscus.app/client.js"
        data-repo="coleea/coleea.github.io" 
        data-repo-id="R_kgDOP9vrtg" 
        data-category="Announcements" 
        data-category-id="DIC_kwDOP9vrts4CwYaB" 
        data-mapping="pathname"
        data-strict="1"
        data-reactions-enabled="1"
        data-emit-metadata="1"
        data-input-position="top"
        data-theme="https://giscus-dkh.pages.dev/A.css"
        data-lang="ko"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
`;

// 정규 표현식을 사용하여 설정 파싱
function extractAttribute(html: string, attr: string): string {
  const regex = new RegExp(`${attr}="([^"]*)"`, 'i');
  const match = html.match(regex);
  return match ? match[1] : '';
}

const config = {
  src: extractAttribute(scriptTagForGiscus, 'src'),
  repo: extractAttribute(scriptTagForGiscus, 'data-repo'),
  repoId: extractAttribute(scriptTagForGiscus, 'data-repo-id'),
  category: extractAttribute(scriptTagForGiscus, 'data-category'),
  categoryId: extractAttribute(scriptTagForGiscus, 'data-category-id'),
  mapping: extractAttribute(scriptTagForGiscus, 'data-mapping') || 'pathname',
  strict: extractAttribute(scriptTagForGiscus, 'data-strict') || '0',
  reactionsEnabled: extractAttribute(scriptTagForGiscus, 'data-reactions-enabled') || '1',
  emitMetadata: extractAttribute(scriptTagForGiscus, 'data-emit-metadata') || '0',
  inputPosition: extractAttribute(scriptTagForGiscus, 'data-input-position') || 'bottom',
  theme: extractAttribute(scriptTagForGiscus, 'data-theme') || 'preferred_color_scheme',
  lang: extractAttribute(scriptTagForGiscus, 'data-lang') || 'ko',
  loading: extractAttribute(scriptTagForGiscus, 'data-loading') || 'lazy'
};
---

<div id="giscus-container"></div>

<script define:vars={{ config }}>
  // 获取当前主题
  function getCurrentTheme() {
    if (config.theme !== 'preferred_color_scheme') {
      return config.theme;
    }
    return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
  }

  // 加载 Giscus
  function loadGiscus() {
    const container = document.getElementById('giscus-container');
    if (!container || container.querySelector('script')) return; // 避免重复加载

    const script = document.createElement('script');
    script.src = config.src || 'https://giscus.app/client.js';
    script.setAttribute('data-repo', config.repo);
    script.setAttribute('data-repo-id', config.repoId);
    script.setAttribute('data-category', config.category);
    script.setAttribute('data-category-id', config.categoryId);
    script.setAttribute('data-mapping', config.mapping);
    script.setAttribute('data-strict', config.strict);
    script.setAttribute('data-reactions-enabled', config.reactionsEnabled);
    script.setAttribute('data-emit-metadata', config.emitMetadata);
    script.setAttribute('data-input-position', config.inputPosition);
    script.setAttribute('data-theme', getCurrentTheme());
    script.setAttribute('data-lang', config.lang);
    script.setAttribute('data-loading', config.loading);
    script.crossOrigin = 'anonymous';
    script.async = true;

    container.appendChild(script);
  }

  // 页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGiscus);
  } else {
    loadGiscus();
  }
</script>